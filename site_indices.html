<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Reto Schmucki" />

<meta name="date" content="2020-03-29" />

<title>Computing site and collated indices</title>

<script src="site_libs/header-attrs-2.22/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">BMS Workshop</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    WS1
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="data_wrangling.html">data wrangling</a>
    </li>
    <li>
      <a href="mapping_site_geoclimate.html">mapping</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    WS2
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="flight_curve_presentation.html">Phenology and GAI</a>
    </li>
    <li>
      <a href="flight_curve_computing.html">Estimating phenology</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    WS3
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="site_indices.html">Site and Collated Index</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    WS4
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="species_trends.html">Species trends</a>
    </li>
    <li>
      <a href="multispecies_indicators.html">Multispecies indicators</a>
    </li>
  </ul>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Computing site and collated indices</h1>
<h4 class="author">Reto Schmucki</h4>
<h4 class="date">29 March 2020</h4>

</div>


<div id="generalized-abundance-index-2" class="section level3">
<h3>Generalized Abundance Index (2)</h3>
<p>After having successfully computed estimates of the regional flight
curve, you can now use this information together with your count data to
estimate a total number of butterfly per monitoring site over a season.
This will provide you with an estimated abundance for each site that can
be used to compute a collated index over the entire regions or a group
of sites.</p>
<p>For this task, we will used the flight curve <a
href="flight_curve_computing.html">computed earlier</a> and the
<code>impute_count</code>, <code>site_index</code> and finally
<code>collated_index</code> functions available in <code>rbms</code>
package</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(rbms)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span></code></pre></div>
<p>Here we will use the count and visit data.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># s_sp &lt;- &quot;Maniola jurtina&quot;</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>s_sp <span class="ot">&lt;-</span> <span class="st">&quot;Polyommatus icarus&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>region_bms <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;NLBMS&quot;</span>, <span class="st">&quot;FRBMS&quot;</span>)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>b_count_sub <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;bms_workshop_data/work_count.rds&quot;</span>)</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>m_visit_sub <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">&quot;bms_workshop_data/work_visit.rds&quot;</span>)</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="fu">setnames</span>(m_visit_sub, <span class="fu">c</span>(<span class="st">&quot;transect_id_serial&quot;</span>, <span class="st">&quot;visit_date&quot;</span>), <span class="fu">c</span>(<span class="st">&quot;SITE_ID&quot;</span>, <span class="st">&quot;DATE&quot;</span>))</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="fu">names</span>(m_visit_sub) <span class="ot">&lt;-</span> <span class="fu">toupper</span>(<span class="fu">names</span>(m_visit_sub))</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="fu">setnames</span>(b_count_sub, <span class="fu">c</span>(<span class="st">&quot;transect_id_serial&quot;</span>, <span class="st">&quot;visit_date&quot;</span>, <span class="st">&quot;species_name&quot;</span>), <span class="fu">c</span>(<span class="st">&quot;SITE_ID&quot;</span>, <span class="st">&quot;DATE&quot;</span>, <span class="st">&quot;SPECIES&quot;</span>))</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="fu">names</span>(b_count_sub) <span class="ot">&lt;-</span> <span class="fu">toupper</span>(<span class="fu">names</span>(b_count_sub))</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>ts_date <span class="ot">&lt;-</span> rbms<span class="sc">::</span><span class="fu">ts_dwmy_table</span>(<span class="at">InitYear =</span> <span class="dv">2008</span>,</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>                               <span class="at">LastYear =</span> <span class="dv">2017</span>,</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>                               <span class="at">WeekDay1 =</span> <span class="st">&quot;monday&quot;</span>)</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>ts_season <span class="ot">&lt;-</span> rbms<span class="sc">::</span><span class="fu">ts_monit_season</span>(ts_date, </span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>                                   <span class="at">StartMonth =</span> <span class="dv">4</span>,</span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>                                   <span class="at">EndMonth =</span> <span class="dv">9</span>, </span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>                                   <span class="at">StartDay =</span> <span class="dv">1</span>, </span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>                                   <span class="at">EndDay =</span> <span class="cn">NULL</span>,</span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>                                   <span class="at">CompltSeason =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>                                   <span class="at">Anchor =</span> <span class="cn">TRUE</span>,</span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>                                   <span class="at">AnchorLength =</span> <span class="dv">2</span>,</span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>                                   <span class="at">AnchorLag =</span> <span class="dv">2</span>,</span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>                                   <span class="at">TimeUnit =</span> <span class="st">&quot;w&quot;</span>)</span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a>MY_visit_region <span class="ot">&lt;-</span> m_visit_sub[BMS_ID <span class="sc">%in%</span> region_bms, ]</span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a>ts_season_visit <span class="ot">&lt;-</span> rbms<span class="sc">::</span><span class="fu">ts_monit_site</span>(MY_visit_region, ts_season)</span></code></pre></div>
<pre><code>## Warning in rbms::ts_monit_site(MY_visit_region, ts_season): We have changed the
## order of the input arguments, with ts_seaon now in first place, before m_visit.</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>MY_count_region <span class="ot">&lt;-</span> b_count_sub[BMS_ID <span class="sc">%in%</span> region_bms, ]</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>ts_season_count <span class="ot">&lt;-</span> rbms<span class="sc">::</span><span class="fu">ts_monit_count_site</span>(ts_season_visit, MY_count_region, <span class="at">sp =</span> s_sp)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co"># ts_flight_curve &lt;- rbms::flight_curve(ts_season_count,</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="co">#                                            NbrSample = 500,</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co">#                                            MinVisit = 3,</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="co">#                                            MinOccur = 2,</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co">#                                            MinNbrSite = 5,</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="co">#                                            MaxTrial = 4,</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="co">#                                            GamFamily = &quot;nb&quot;,</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="co">#                                            SpeedGam = FALSE,</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="co">#                                            CompltSeason = TRUE,</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="co">#                                            SelectYear = NULL,</span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a><span class="co">#                                            TimeUnit = &quot;w&quot;</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a><span class="co">#                                            )</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>ts_flight_curve <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(<span class="st">&quot;bms_workshop_data&quot;</span>, <span class="fu">paste</span>(<span class="fu">gsub</span>(<span class="st">&quot; &quot;</span>, <span class="st">&quot;_&quot;</span>, s_sp), <span class="fu">paste</span>(region_bms, <span class="at">collapse=</span><span class="st">&quot;_&quot;</span>), <span class="st">&quot;pheno.rds&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;_&quot;</span>)))</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>pheno <span class="ot">&lt;-</span> ts_flight_curve<span class="sc">$</span>pheno</span></code></pre></div>
</div>
<div id="impute-site-index" class="section level3">
<h3>Impute &amp; Site index</h3>
<p>With the phenology and teh observed counts, you can now impute values
for missing week counts and adequately compute sites abundance index
over the entire monitoring season.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>impt_counts <span class="ot">&lt;-</span> rbms<span class="sc">::</span><span class="fu">impute_count</span>(<span class="at">ts_season_count =</span> ts_season_count, </span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>                                  <span class="at">ts_flight_curve =</span> pheno, </span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>                                  <span class="at">YearLimit =</span> <span class="cn">NULL</span>, </span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>                                  <span class="at">TimeUnit =</span> <span class="st">&quot;w&quot;</span>)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>sindex <span class="ot">&lt;-</span> rbms<span class="sc">::</span><span class="fu">site_index</span>(<span class="at">butterfly_count =</span> impt_counts, <span class="at">MinFC =</span> <span class="fl">0.10</span>)</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="fu">saveRDS</span>(sindex, <span class="fu">file.path</span>(<span class="st">&quot;bms_workshop_data&quot;</span>, <span class="fu">paste</span>( <span class="fu">gsub</span>(<span class="st">&quot; &quot;</span>, <span class="st">&quot;_&quot;</span>, s_sp), <span class="fu">paste</span>(region_bms, <span class="at">collapse=</span><span class="st">&quot;_&quot;</span>), <span class="st">&quot;sindex.rds&quot;</span>, <span class="at">sep=</span><span class="st">&quot;_&quot;</span>)))</span></code></pre></div>
</div>
<div id="collated-index" class="section level3">
<h3>Collated index</h3>
<p>Now that we have all each site index, we can collate them together to
estimate annual abundance indices for the wider region, using the
<code>collated_index</code> function in <code>rbms</code>. For this
example, we will focus on the sites monitored in the Netherlands (NLBMS)
and compute a collated index for <em>Polyommatus icarus</em> accross the
site monitored in that region over the 10-year period.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>bms_id <span class="ot">&lt;-</span> <span class="st">&quot;NLBMS&quot;</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>sindex <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(<span class="st">&quot;bms_workshop_data&quot;</span>, <span class="fu">paste</span>( <span class="fu">gsub</span>(<span class="st">&quot; &quot;</span>, <span class="st">&quot;_&quot;</span>, s_sp), <span class="fu">paste</span>(region_bms, <span class="at">collapse=</span><span class="st">&quot;_&quot;</span>), <span class="st">&quot;sindex.rds&quot;</span>, <span class="at">sep=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>sindex[<span class="fu">substr</span>(SITE_ID, <span class="dv">1</span>, <span class="dv">5</span>) <span class="sc">==</span> bms_id, ]</span></code></pre></div>
<pre><code>##                  SPECIES   SITE_ID M_YEAR TOTAL_NM    SINDEX
##    1: Polyommatus icarus   NLBMS.1   2008  0.38968 87.251078
##    2: Polyommatus icarus  NLBMS.10   2008  0.70761  0.000000
##    3: Polyommatus icarus NLBMS.100   2008  0.39172 12.764219
##    4: Polyommatus icarus  NLBMS.11   2008  0.70421 12.780279
##    5: Polyommatus icarus  NLBMS.12   2008  0.76831  1.301558
##   ---                                                       
## 2496: Polyommatus icarus  NLBMS.94   2017  0.38629  7.766186
## 2497: Polyommatus icarus  NLBMS.95   2017  0.35916  0.000000
## 2498: Polyommatus icarus  NLBMS.96   2017  0.68859  0.000000
## 2499: Polyommatus icarus  NLBMS.97   2017  0.70718 21.211007
## 2500: Polyommatus icarus  NLBMS.98   2017  0.52548  7.612088</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>co_index <span class="ot">&lt;-</span> <span class="fu">collated_index</span>(<span class="at">data =</span> sindex[<span class="fu">substr</span>(SITE_ID, <span class="dv">1</span>, <span class="dv">5</span>) <span class="sc">==</span> bms_id, ], </span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>                           <span class="at">s_sp =</span> s_sp,</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>                           <span class="at">sindex_value =</span> <span class="st">&quot;SINDEX&quot;</span>,</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>                           <span class="at">glm_weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>                           <span class="at">rm_zero =</span> <span class="cn">TRUE</span>)</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>co_index<span class="sc">$</span>col_index</span></code></pre></div>
<pre><code>##     BOOTi M_YEAR NSITE NSITE_B NSITE_OBS COL_INDEX
##  1:     0   2008   203     203       137  23.33228
##  2:     0   2009   222     222       187  73.34732
##  3:     0   2010   236     236       191  53.97436
##  4:     0   2011   262     262       193  25.88315
##  5:     0   2012   272     272       188  24.61936
##  6:     0   2013   283     283       233  68.24259
##  7:     0   2014   277     277       224  46.84152
##  8:     0   2015   269     269       216  33.83268
##  9:     0   2016   255     255       191  26.45301
## 10:     0   2017   221     221       167  40.75606</code></pre>
</div>
<div id="bootstrap-ci" class="section level3">
<h3>Bootstrap CI</h3>
<p>With this sample of site indices, we can compute the collated indices
for multiple combination of sites. Using a bootstrap approach, we can
now estimate the confidence interval around the estimated collated
index, using the variation observed between monitoring sites. First we
randomly draw <em>n</em> bootstrap samples, using the function
<code>boot_sample</code>. This function sample with replacement from a
the pool of all sites available. Because sampling is done with
replacement, site can occur twice in a specific bootstrap sample and it
will be treated as two independent sites (realisations). Here we use a
500 bootstrap, with set.seed() sake of cpu time and repeatability, but
you should aim for 1000 sample and more and remove the set.seed() in the
random number generator to generate different samples between runs.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>bms_id <span class="ot">&lt;-</span> <span class="st">&quot;NLBMS&quot;</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">125361</span>)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>bootsample <span class="ot">&lt;-</span> rbms<span class="sc">::</span><span class="fu">boot_sample</span>(sindex[<span class="fu">substr</span>(SITE_ID, <span class="dv">1</span>, <span class="dv">5</span>) <span class="sc">==</span> bms_id, ], <span class="at">boot_n =</span> <span class="dv">500</span>)</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>co_index <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="do">## for progression bar, uncomment the following</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>pb <span class="ot">&lt;-</span> <span class="fu">txtProgressBar</span>(<span class="at">min =</span> <span class="dv">0</span>, <span class="at">max =</span> <span class="fu">dim</span>(bootsample<span class="sc">$</span>boot_ind)[<span class="dv">1</span>], <span class="at">initial =</span> <span class="dv">0</span>, <span class="at">char =</span> <span class="st">&quot;*&quot;</span>,  <span class="at">style =</span> <span class="dv">3</span>)</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">seq_len</span>(<span class="fu">dim</span>(bootsample<span class="sc">$</span>boot_ind)[<span class="dv">1</span>]))) {</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>    co_index[[i <span class="sc">+</span> <span class="dv">1</span>]] <span class="ot">&lt;-</span> rbms<span class="sc">::</span><span class="fu">collated_index</span>(<span class="at">data =</span> sindex[<span class="fu">substr</span>(SITE_ID, <span class="dv">1</span>, <span class="dv">5</span>) <span class="sc">==</span> bms_id, ],</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>                                              <span class="at">s_sp =</span> s_sp,</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>                                              <span class="at">sindex_value =</span> <span class="st">&quot;SINDEX&quot;</span>,</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>                                              <span class="at">bootID =</span> i,</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>                                              <span class="at">boot_ind =</span> bootsample,</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>                                              <span class="at">glm_weights =</span> <span class="cn">TRUE</span>,</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>                                              <span class="at">rm_zero =</span> <span class="cn">TRUE</span>)</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>    <span class="do">## for progression bar, uncomment the following</span></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>    <span class="fu">setTxtProgressBar</span>(pb, i)</span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>}</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a><span class="do">## collate and append all the result in a data.table format</span></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>co_index <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(<span class="fu">lapply</span>(co_index, <span class="at">FUN =</span> <span class="st">&quot;[[&quot;</span>, <span class="st">&quot;col_index&quot;</span>))</span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>co_index<span class="sc">$</span>BMS_ID <span class="ot">&lt;-</span> bms_id</span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>co_index<span class="sc">$</span>SPECIES <span class="ot">&lt;-</span> s_sp</span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a></span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>co_index_boot <span class="ot">&lt;-</span> co_index</span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a><span class="fu">saveRDS</span>(co_index_boot, <span class="fu">file.path</span>(<span class="st">&quot;bms_workshop_data&quot;</span>, <span class="fu">paste</span>( <span class="fu">gsub</span>(<span class="st">&quot; &quot;</span>, <span class="st">&quot;_&quot;</span>, s_sp), bms_id, <span class="st">&quot;co_index_boot.rds&quot;</span>, <span class="at">sep=</span><span class="st">&quot;_&quot;</span>)))</span></code></pre></div>
</div>
<div id="figure-with-ci" class="section level3">
<h3>Figure with CI</h3>
<p>Now that you have a collated index, and a series bootstrapped
collated indices, you can compute a 95% Confidence Interval around your
index and construct a figure to illustrate the temporal trend resulting
from the annual indices. Here we will rescale and present the indices on
a log(index)/log(10) scale. Confidence interval are computed using the
0.025 and 0.975 quantile from the <em>n</em> bootstrap sample.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>bms_id <span class="ot">&lt;-</span> <span class="st">&quot;NLBMS&quot;</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>co_index_boot <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">file.path</span>(<span class="st">&quot;bms_workshop_data&quot;</span>, <span class="fu">paste</span>( <span class="fu">gsub</span>(<span class="st">&quot; &quot;</span>, <span class="st">&quot;_&quot;</span>, s_sp), bms_id, <span class="st">&quot;co_index_boot.rds&quot;</span>, <span class="at">sep=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>boot0 <span class="ot">&lt;-</span> co_index_boot[ , <span class="fu">mean</span>(COL_INDEX, <span class="at">na.rm=</span><span class="cn">TRUE</span>), by <span class="ot">=</span> M_YEAR]</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>boot0[, LOGDENSITY0 <span class="sc">:=</span> <span class="fu">log</span>(V1) <span class="sc">/</span> <span class="fu">log</span>(<span class="dv">10</span>)]</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>boot0[, meanlog0 <span class="sc">:=</span> <span class="fu">mean</span>(LOGDENSITY0)]</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="co"># Add mean of BOOTi == 0 (real data) to all data</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>boot_ests <span class="ot">&lt;-</span> <span class="fu">merge</span>(co_index_boot, boot0[, .(M_YEAR, meanlog0)],</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;M_YEAR&quot;</span>)</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>    )</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>boot_ests[, LOGDENSITY <span class="sc">:=</span> <span class="fu">log</span>(COL_INDEX) <span class="sc">/</span> <span class="fu">log</span>(<span class="dv">10</span>)]</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>boot_ests[, TRMOBSCI <span class="sc">:=</span> LOGDENSITY <span class="sc">-</span> meanlog0 <span class="sc">+</span> <span class="dv">2</span>]</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>boot_ests[, TRMOBSCILOW <span class="sc">:=</span> <span class="fu">quantile</span>(TRMOBSCI, <span class="fl">0.025</span>), by <span class="ot">=</span> M_YEAR]</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>boot_ests[, TRMOBSCIUPP <span class="sc">:=</span> <span class="fu">quantile</span>(TRMOBSCI, <span class="fl">0.975</span>), by <span class="ot">=</span> M_YEAR]</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>ylim_ <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(<span class="fu">floor</span>(<span class="fu">range</span>(boot_ests[TRMOBSCI <span class="sc">&lt;=</span> TRMOBSCIUPP <span class="sc">&amp;</span> TRMOBSCI <span class="sc">&gt;=</span> TRMOBSCILOW, TRMOBSCI]))),</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>           <span class="fu">max</span>(<span class="fu">ceiling</span>(<span class="fu">range</span>(boot_ests[TRMOBSCI <span class="sc">&lt;=</span> TRMOBSCIUPP <span class="sc">&amp;</span> TRMOBSCI <span class="sc">&gt;=</span> TRMOBSCILOW, TRMOBSCI]))))</span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>plot_col <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(<span class="at">data =</span> boot_ests[TRMOBSCI <span class="sc">&lt;=</span> TRMOBSCIUPP <span class="sc">&amp;</span> TRMOBSCI <span class="sc">&gt;=</span> TRMOBSCILOW, ], <span class="fu">aes</span>(<span class="at">x =</span> M_YEAR, <span class="at">y =</span> TRMOBSCI)) <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">colour =</span> <span class="st">&quot;orange&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>) <span class="sc">+</span> <span class="fu">ylim</span>(ylim_) <span class="sc">+</span></span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> boot_ests[TRMOBSCI <span class="sc">&lt;=</span> TRMOBSCIUPP <span class="sc">&amp;</span> TRMOBSCI <span class="sc">&gt;=</span> TRMOBSCILOW, <span class="fu">median</span>(TRMOBSCI, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="at">by =</span> M_YEAR], <span class="fu">aes</span>(<span class="at">x =</span> M_YEAR, <span class="at">y =</span> V1), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="st">&quot;dodgerblue4&quot;</span>) <span class="sc">+</span></span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">2</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="at">color =</span> <span class="st">&quot;grey50&quot;</span>) <span class="sc">+</span></span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>    <span class="fu">scale_x_continuous</span>(<span class="at">minor_breaks =</span> <span class="fu">waiver</span>(), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">2005</span>, <span class="dv">2020</span>), <span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">2005</span>, <span class="dv">2020</span>, <span class="at">by =</span> <span class="dv">5</span>)) <span class="sc">+</span> </span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>    <span class="fu">xlab</span>(<span class="st">&quot;Year&quot;</span>) <span class="sc">+</span> <span class="fu">ylab</span>(<span class="st">&quot;Abundance Incices (Log/Log(10))&quot;</span>) <span class="sc">+</span></span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="fu">paste</span>(s_sp, bms_id, <span class="at">sep =</span> <span class="st">&quot; &quot;</span>))</span></code></pre></div>
<pre><code>## Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.
## ℹ Please use `linewidth` instead.
## This warning is displayed once every 8 hours.
## Call `lifecycle::last_lifecycle_warnings()` to see where this warning was generated.</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>plot_col</span></code></pre></div>
<p><img src="site_indices_files/figure-html/collated_index_figure-1.png" width="672" /></p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
