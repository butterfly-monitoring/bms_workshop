<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Reto Schmucki" />

<meta name="date" content="2020-03-29" />

<title>Computing site and collated indices</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<script src="site_libs/elevate-section-attrs-2.0/elevate-section-attrs.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

.sourceCode .row {
  width: 100%;
}
.sourceCode {
  overflow-x: auto;
}
.code-folding-btn {
  margin-right: -30px;
}
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">BMS Workshop</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    WS1
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="data_wrangling.html">data wrangling</a>
    </li>
    <li>
      <a href="mapping_site_geoclimate.html">mapping</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    WS2
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="flight_curve_presentation.html">Phenology and GAI</a>
    </li>
    <li>
      <a href="flight_curve_computing.html">Estimating phenology</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    WS3
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="site_indices.html">Site and Collated Index</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    WS4
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="species_trends.html">Species trends</a>
    </li>
    <li>
      <a href="multispecies_indicators.html">Multispecies indicators</a>
    </li>
  </ul>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Computing site and collated indices</h1>
<h4 class="author">Reto Schmucki</h4>
<h4 class="date">29 March 2020</h4>

</div>


<div id="generalized-abundance-index-2" class="section level3">
<h3>Generalized Abundance Index (2)</h3>
<p>After having successfully computed estimates of the regional flight curve, you can now use this information together with your count data to estimate a total number of butterfly per monitoring site over a season. This will provide you with an estimated abundance for each site that can be used to compute a collated index over the entire regions or a group of sites.</p>
<p>For this task, we will used the flight curve <a href="flight_curve_computing.html">computed earlier</a> and the <code>impute_count</code>, <code>site_index</code> and finally <code>collated_index</code> functions available in <code>rbms</code> package</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(data.table)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="kw">library</span>(rbms)</span></code></pre></div>
<p>Here we will use the count and visit data.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># s_sp &lt;- &quot;Maniola jurtina&quot;</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>s_sp &lt;-<span class="st"> &quot;Polyommatus icarus&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>region_bms &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;NLBMS&quot;</span>, <span class="st">&quot;FRBMS&quot;</span>)</span>
<span id="cb2-4"><a href="#cb2-4"></a></span>
<span id="cb2-5"><a href="#cb2-5"></a>b_count_sub &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;my_code/bms_workshop_data/work_count.rds&quot;</span>)</span>
<span id="cb2-6"><a href="#cb2-6"></a>m_visit_sub &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;my_code/bms_workshop_data/work_visit.rds&quot;</span>)</span>
<span id="cb2-7"><a href="#cb2-7"></a></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="kw">setnames</span>(m_visit_sub, <span class="kw">c</span>(<span class="st">&quot;transect_id_serial&quot;</span>, <span class="st">&quot;visit_date&quot;</span>), <span class="kw">c</span>(<span class="st">&quot;SITE_ID&quot;</span>, <span class="st">&quot;DATE&quot;</span>))</span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="kw">names</span>(m_visit_sub) &lt;-<span class="st"> </span><span class="kw">toupper</span>(<span class="kw">names</span>(m_visit_sub))</span>
<span id="cb2-10"><a href="#cb2-10"></a></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="kw">setnames</span>(b_count_sub, <span class="kw">c</span>(<span class="st">&quot;transect_id_serial&quot;</span>, <span class="st">&quot;visit_date&quot;</span>, <span class="st">&quot;species_name&quot;</span>), <span class="kw">c</span>(<span class="st">&quot;SITE_ID&quot;</span>, <span class="st">&quot;DATE&quot;</span>, <span class="st">&quot;SPECIES&quot;</span>))</span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="kw">names</span>(b_count_sub) &lt;-<span class="st"> </span><span class="kw">toupper</span>(<span class="kw">names</span>(b_count_sub))</span>
<span id="cb2-13"><a href="#cb2-13"></a></span>
<span id="cb2-14"><a href="#cb2-14"></a>ts_date &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw">ts_dwmy_table</span>(<span class="dt">InitYear =</span> <span class="dv">2008</span>,</span>
<span id="cb2-15"><a href="#cb2-15"></a>                               <span class="dt">LastYear =</span> <span class="dv">2017</span>,</span>
<span id="cb2-16"><a href="#cb2-16"></a>                               <span class="dt">WeekDay1 =</span> <span class="st">&quot;monday&quot;</span>)</span>
<span id="cb2-17"><a href="#cb2-17"></a></span>
<span id="cb2-18"><a href="#cb2-18"></a>ts_season &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw">ts_monit_season</span>(ts_date, </span>
<span id="cb2-19"><a href="#cb2-19"></a>                                   <span class="dt">StartMonth =</span> <span class="dv">4</span>,</span>
<span id="cb2-20"><a href="#cb2-20"></a>                                   <span class="dt">EndMonth =</span> <span class="dv">9</span>, </span>
<span id="cb2-21"><a href="#cb2-21"></a>                                   <span class="dt">StartDay =</span> <span class="dv">1</span>, </span>
<span id="cb2-22"><a href="#cb2-22"></a>                                   <span class="dt">EndDay =</span> <span class="ot">NULL</span>,</span>
<span id="cb2-23"><a href="#cb2-23"></a>                                   <span class="dt">CompltSeason =</span> <span class="ot">TRUE</span>,</span>
<span id="cb2-24"><a href="#cb2-24"></a>                                   <span class="dt">Anchor =</span> <span class="ot">TRUE</span>,</span>
<span id="cb2-25"><a href="#cb2-25"></a>                                   <span class="dt">AnchorLength =</span> <span class="dv">2</span>,</span>
<span id="cb2-26"><a href="#cb2-26"></a>                                   <span class="dt">AnchorLag =</span> <span class="dv">2</span>,</span>
<span id="cb2-27"><a href="#cb2-27"></a>                                   <span class="dt">TimeUnit =</span> <span class="st">&quot;w&quot;</span>)</span>
<span id="cb2-28"><a href="#cb2-28"></a></span>
<span id="cb2-29"><a href="#cb2-29"></a>MY_visit_region &lt;-<span class="st"> </span>m_visit_sub[BMS_ID <span class="op">%in%</span><span class="st"> </span>region_bms, ]</span>
<span id="cb2-30"><a href="#cb2-30"></a>ts_season_visit &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw">ts_monit_site</span>(MY_visit_region, ts_season)</span>
<span id="cb2-31"><a href="#cb2-31"></a></span>
<span id="cb2-32"><a href="#cb2-32"></a>MY_count_region &lt;-<span class="st"> </span>b_count_sub[BMS_ID <span class="op">%in%</span><span class="st"> </span>region_bms, ]</span>
<span id="cb2-33"><a href="#cb2-33"></a>ts_season_count &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw">ts_monit_count_site</span>(ts_season_visit, MY_count_region, <span class="dt">sp =</span> s_sp)</span>
<span id="cb2-34"><a href="#cb2-34"></a><span class="co"># ts_flight_curve &lt;- rbms::flight_curve(ts_season_count,</span></span>
<span id="cb2-35"><a href="#cb2-35"></a><span class="co">#                                            NbrSample = 500,</span></span>
<span id="cb2-36"><a href="#cb2-36"></a><span class="co">#                                            MinVisit = 3,</span></span>
<span id="cb2-37"><a href="#cb2-37"></a><span class="co">#                                            MinOccur = 2,</span></span>
<span id="cb2-38"><a href="#cb2-38"></a><span class="co">#                                            MinNbrSite = 5,</span></span>
<span id="cb2-39"><a href="#cb2-39"></a><span class="co">#                                            MaxTrial = 4,</span></span>
<span id="cb2-40"><a href="#cb2-40"></a><span class="co">#                                            GamFamily = &quot;nb&quot;,</span></span>
<span id="cb2-41"><a href="#cb2-41"></a><span class="co">#                                            SpeedGam = FALSE,</span></span>
<span id="cb2-42"><a href="#cb2-42"></a><span class="co">#                                            CompltSeason = TRUE,</span></span>
<span id="cb2-43"><a href="#cb2-43"></a><span class="co">#                                            SelectYear = NULL,</span></span>
<span id="cb2-44"><a href="#cb2-44"></a><span class="co">#                                            TimeUnit = &quot;w&quot;</span></span>
<span id="cb2-45"><a href="#cb2-45"></a><span class="co">#                                            )</span></span>
<span id="cb2-46"><a href="#cb2-46"></a>ts_flight_curve &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="kw">file.path</span>(<span class="st">&quot;my_code/bms_workshop_data&quot;</span>, <span class="kw">paste</span>(<span class="kw">gsub</span>(<span class="st">&quot; &quot;</span>, <span class="st">&quot;_&quot;</span>, s_sp), <span class="kw">paste</span>(region_bms, <span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>), <span class="st">&quot;pheno.rds&quot;</span>, <span class="dt">sep =</span> <span class="st">&quot;_&quot;</span>)))</span>
<span id="cb2-47"><a href="#cb2-47"></a>pheno &lt;-<span class="st"> </span>ts_flight_curve<span class="op">$</span>pheno</span></code></pre></div>
</div>
<div id="impute-site-index" class="section level3">
<h3>Impute &amp; Site index</h3>
<p>With the phenology and teh observed counts, you can now impute values for missing week counts and adequately compute sites abundance index over the entire monitoring season.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>impt_counts &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw">impute_count</span>(<span class="dt">ts_season_count =</span> ts_season_count, </span>
<span id="cb3-2"><a href="#cb3-2"></a>                                  <span class="dt">ts_flight_curve =</span> pheno, </span>
<span id="cb3-3"><a href="#cb3-3"></a>                                  <span class="dt">YearLimit =</span> <span class="ot">NULL</span>, </span>
<span id="cb3-4"><a href="#cb3-4"></a>                                  <span class="dt">TimeUnit =</span> <span class="st">&quot;w&quot;</span>)</span>
<span id="cb3-5"><a href="#cb3-5"></a></span>
<span id="cb3-6"><a href="#cb3-6"></a>sindex &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw">site_index</span>(<span class="dt">butterfly_count =</span> impt_counts, <span class="dt">MinFC =</span> <span class="fl">0.10</span>)</span>
<span id="cb3-7"><a href="#cb3-7"></a></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="kw">saveRDS</span>(sindex, <span class="kw">file.path</span>(<span class="st">&quot;my_code/bms_workshop_data&quot;</span>, <span class="kw">paste</span>( <span class="kw">gsub</span>(<span class="st">&quot; &quot;</span>, <span class="st">&quot;_&quot;</span>, s_sp), <span class="kw">paste</span>(region_bms, <span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>), <span class="st">&quot;sindex.rds&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;_&quot;</span>)))</span></code></pre></div>
</div>
<div id="collated-index" class="section level3">
<h3>Collated index</h3>
<p>Now that we have all each site index, we can collate them together to estimate annual abundance indices for the wider region, using the <code>collated_index</code> function in <code>rbms</code>. For this example, we will focus on the sites monitored in the Netherlands (NLBMS) and compute a collated index for <em>Polyommatus icarus</em> accross the site monitored in that region over the 10-year period.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>bms_id &lt;-<span class="st"> &quot;NLBMS&quot;</span></span>
<span id="cb4-2"><a href="#cb4-2"></a></span>
<span id="cb4-3"><a href="#cb4-3"></a>sindex &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="kw">file.path</span>(<span class="st">&quot;my_code/bms_workshop_data&quot;</span>, <span class="kw">paste</span>( <span class="kw">gsub</span>(<span class="st">&quot; &quot;</span>, <span class="st">&quot;_&quot;</span>, s_sp), <span class="kw">paste</span>(region_bms, <span class="dt">collapse=</span><span class="st">&quot;_&quot;</span>), <span class="st">&quot;sindex.rds&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a>sindex[<span class="kw">substr</span>(SITE_ID, <span class="dv">1</span>, <span class="dv">5</span>) <span class="op">==</span><span class="st"> </span>bms_id, ]</span></code></pre></div>
<pre><code>##                  SPECIES   SITE_ID M_YEAR TOTAL_NM    SINDEX
##    1: Polyommatus icarus   NLBMS.1   2008  0.38968 87.251078
##    2: Polyommatus icarus  NLBMS.10   2008  0.70761  0.000000
##    3: Polyommatus icarus NLBMS.100   2008  0.39172 12.764219
##    4: Polyommatus icarus  NLBMS.11   2008  0.70421 12.780279
##    5: Polyommatus icarus  NLBMS.12   2008  0.76831  1.301558
##   ---                                                       
## 2516: Polyommatus icarus  NLBMS.94   2017  0.35151  8.534608
## 2517: Polyommatus icarus  NLBMS.95   2017  0.44468  0.000000
## 2518: Polyommatus icarus  NLBMS.96   2017  0.69362  0.000000
## 2519: Polyommatus icarus  NLBMS.97   2017  0.73042 20.536130
## 2520: Polyommatus icarus  NLBMS.98   2017  0.48523 10.304392</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>co_index &lt;-<span class="st"> </span><span class="kw">collated_index</span>(<span class="dt">data =</span> sindex[<span class="kw">substr</span>(SITE_ID, <span class="dv">1</span>, <span class="dv">5</span>) <span class="op">==</span><span class="st"> </span>bms_id, ], </span>
<span id="cb6-2"><a href="#cb6-2"></a>                           <span class="dt">s_sp =</span> s_sp,</span>
<span id="cb6-3"><a href="#cb6-3"></a>                           <span class="dt">sindex_value =</span> <span class="st">&quot;SINDEX&quot;</span>,</span>
<span id="cb6-4"><a href="#cb6-4"></a>                           <span class="dt">glm_weights =</span> <span class="ot">TRUE</span>,</span>
<span id="cb6-5"><a href="#cb6-5"></a>                           <span class="dt">rm_zero =</span> <span class="ot">TRUE</span>)</span>
<span id="cb6-6"><a href="#cb6-6"></a>co_index<span class="op">$</span>col_index</span></code></pre></div>
<pre><code>##     BOOTi M_YEAR NSITE NSITE_OBS COL_INDEX
##  1:     0   2008   203       137  24.46021
##  2:     0   2009   224       187  73.64242
##  3:     0   2010   236       191  52.79313
##  4:     0   2011   261       194  27.48493
##  5:     0   2012   277       189  24.85320
##  6:     0   2013   283       233  71.30772
##  7:     0   2014   277       224  48.47070
##  8:     0   2015   275       220  35.41614
##  9:     0   2016   258       192  26.56655
## 10:     0   2017   226       171  41.44783</code></pre>
</div>
<div id="bootstrap-ci" class="section level3">
<h3>Bootstrap CI</h3>
<p>With this sample of site indices, we can compute the collated indices for multiple combination of sites. Using a bootstrap approach, we can now estimate the confidence interval around the estimated collated index, using the variation observed between monitoring sites. First we randomly draw <em>n</em> bootstrap samples, using the function <code>boot_sample</code>. This function sample with replacement from a the pool of all sites available. Because sampling is done with replacement, site can occur twice in a specific bootstrap sample and it will be treated as two independent sites (realisations). Here we use a 500 bootstrap, with set.seed() sake of cpu time and repeatability, but you should aim for 1000 sample and more and remove the set.seed() in the random number generator to generate different samples between runs.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>bms_id &lt;-<span class="st"> &quot;NLBMS&quot;</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="kw">set.seed</span>(<span class="dv">125361</span>)</span>
<span id="cb8-3"><a href="#cb8-3"></a></span>
<span id="cb8-4"><a href="#cb8-4"></a>bootsample &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw">boot_sample</span>(sindex[<span class="kw">substr</span>(SITE_ID, <span class="dv">1</span>, <span class="dv">5</span>) <span class="op">==</span><span class="st"> </span>bms_id, ], <span class="dt">boot_n =</span> <span class="dv">500</span>)</span>
<span id="cb8-5"><a href="#cb8-5"></a>co_index &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb8-6"><a href="#cb8-6"></a></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="co">## for progression bar, uncomment the following</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>pb &lt;-<span class="st"> </span><span class="kw">txtProgressBar</span>(<span class="dt">min =</span> <span class="dv">0</span>, <span class="dt">max =</span> <span class="kw">dim</span>(bootsample<span class="op">$</span>boot_ind)[<span class="dv">1</span>], <span class="dt">initial =</span> <span class="dv">0</span>, <span class="dt">char =</span> <span class="st">&quot;*&quot;</span>,  <span class="dt">style =</span> <span class="dv">3</span>)</span>
<span id="cb8-9"><a href="#cb8-9"></a></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">c</span>(<span class="dv">0</span>, <span class="kw">seq_len</span>(<span class="kw">dim</span>(bootsample<span class="op">$</span>boot_ind)[<span class="dv">1</span>]))) {</span>
<span id="cb8-11"><a href="#cb8-11"></a>    co_index[[i <span class="op">+</span><span class="st"> </span><span class="dv">1</span>]] &lt;-<span class="st"> </span>rbms<span class="op">::</span><span class="kw">collated_index</span>(<span class="dt">data =</span> sindex[<span class="kw">substr</span>(SITE_ID, <span class="dv">1</span>, <span class="dv">5</span>) <span class="op">==</span><span class="st"> </span>bms_id, ],</span>
<span id="cb8-12"><a href="#cb8-12"></a>                                              <span class="dt">s_sp =</span> s_sp,</span>
<span id="cb8-13"><a href="#cb8-13"></a>                                              <span class="dt">sindex_value =</span> <span class="st">&quot;SINDEX&quot;</span>,</span>
<span id="cb8-14"><a href="#cb8-14"></a>                                              <span class="dt">bootID =</span> i,</span>
<span id="cb8-15"><a href="#cb8-15"></a>                                              <span class="dt">boot_ind =</span> bootsample,</span>
<span id="cb8-16"><a href="#cb8-16"></a>                                              <span class="dt">glm_weights =</span> <span class="ot">TRUE</span>,</span>
<span id="cb8-17"><a href="#cb8-17"></a>                                              <span class="dt">rm_zero =</span> <span class="ot">TRUE</span>)</span>
<span id="cb8-18"><a href="#cb8-18"></a></span>
<span id="cb8-19"><a href="#cb8-19"></a>    <span class="co">## for progression bar, uncomment the following</span></span>
<span id="cb8-20"><a href="#cb8-20"></a>    <span class="kw">setTxtProgressBar</span>(pb, i)</span>
<span id="cb8-21"><a href="#cb8-21"></a>}</span>
<span id="cb8-22"><a href="#cb8-22"></a></span>
<span id="cb8-23"><a href="#cb8-23"></a><span class="co">## collate and append all the result in a data.table format</span></span>
<span id="cb8-24"><a href="#cb8-24"></a>co_index &lt;-<span class="st"> </span><span class="kw">rbindlist</span>(<span class="kw">lapply</span>(co_index, <span class="dt">FUN =</span> <span class="st">&quot;[[&quot;</span>, <span class="st">&quot;col_index&quot;</span>))</span>
<span id="cb8-25"><a href="#cb8-25"></a>co_index<span class="op">$</span>BMS_ID &lt;-<span class="st"> </span>bms_id</span>
<span id="cb8-26"><a href="#cb8-26"></a>co_index<span class="op">$</span>SPECIES &lt;-<span class="st"> </span>s_sp</span>
<span id="cb8-27"><a href="#cb8-27"></a></span>
<span id="cb8-28"><a href="#cb8-28"></a>co_index_boot &lt;-<span class="st"> </span>co_index</span>
<span id="cb8-29"><a href="#cb8-29"></a><span class="kw">saveRDS</span>(co_index_boot, <span class="kw">file.path</span>(<span class="st">&quot;my_code/bms_workshop_data&quot;</span>, <span class="kw">paste</span>( <span class="kw">gsub</span>(<span class="st">&quot; &quot;</span>, <span class="st">&quot;_&quot;</span>, s_sp), bms_id, <span class="st">&quot;co_index_boot.rds&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;_&quot;</span>)))</span></code></pre></div>
</div>
<div id="figure-with-ci" class="section level3">
<h3>Figure with CI</h3>
<p>Now that you have a collated index, and a series bootstrapped collated indices, you can compute a 95% Confidence Interval around your index and construct a figure to illustrate the temporal trend resulting from the annual indices. Here we will rescale and present the indices on a log(index)/log(10) scale. Confidence interval are computed using the 0.025 and 0.975 quantile from the <em>n</em> bootstrap sample.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>bms_id &lt;-<span class="st"> &quot;NLBMS&quot;</span></span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a>co_index_boot &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="kw">file.path</span>(<span class="st">&quot;my_code/bms_workshop_data&quot;</span>, <span class="kw">paste</span>( <span class="kw">gsub</span>(<span class="st">&quot; &quot;</span>, <span class="st">&quot;_&quot;</span>, s_sp), bms_id, <span class="st">&quot;co_index_boot.rds&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;_&quot;</span>)))</span>
<span id="cb9-4"><a href="#cb9-4"></a></span>
<span id="cb9-5"><a href="#cb9-5"></a>boot0 &lt;-<span class="st"> </span>co_index_boot[ , <span class="kw">mean</span>(COL_INDEX, <span class="dt">na.rm=</span><span class="ot">TRUE</span>), by =<span class="st"> </span>M_YEAR]</span>
<span id="cb9-6"><a href="#cb9-6"></a>boot0[, LOGDENSITY0 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">log</span>(V1) <span class="op">/</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">10</span>)]</span>
<span id="cb9-7"><a href="#cb9-7"></a>boot0[, meanlog0 <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">mean</span>(LOGDENSITY0)]</span>
<span id="cb9-8"><a href="#cb9-8"></a></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="co"># Add mean of BOOTi == 0 (real data) to all data</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>boot_ests &lt;-<span class="st"> </span><span class="kw">merge</span>(co_index_boot, boot0[, .(M_YEAR, meanlog0)],</span>
<span id="cb9-11"><a href="#cb9-11"></a>    <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;M_YEAR&quot;</span>)</span>
<span id="cb9-12"><a href="#cb9-12"></a>    )</span>
<span id="cb9-13"><a href="#cb9-13"></a></span>
<span id="cb9-14"><a href="#cb9-14"></a>boot_ests[, LOGDENSITY <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">log</span>(COL_INDEX) <span class="op">/</span><span class="st"> </span><span class="kw">log</span>(<span class="dv">10</span>)]</span>
<span id="cb9-15"><a href="#cb9-15"></a>boot_ests[, TRMOBSCI <span class="op">:</span><span class="er">=</span><span class="st"> </span>LOGDENSITY <span class="op">-</span><span class="st"> </span>meanlog0 <span class="op">+</span><span class="st"> </span><span class="dv">2</span>]</span>
<span id="cb9-16"><a href="#cb9-16"></a></span>
<span id="cb9-17"><a href="#cb9-17"></a>boot_ests[, TRMOBSCILOW <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">quantile</span>(TRMOBSCI, <span class="fl">0.025</span>), by =<span class="st"> </span>M_YEAR]</span>
<span id="cb9-18"><a href="#cb9-18"></a>boot_ests[, TRMOBSCIUPP <span class="op">:</span><span class="er">=</span><span class="st"> </span><span class="kw">quantile</span>(TRMOBSCI, <span class="fl">0.975</span>), by =<span class="st"> </span>M_YEAR]</span>
<span id="cb9-19"><a href="#cb9-19"></a></span>
<span id="cb9-20"><a href="#cb9-20"></a>ylim_ &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">min</span>(<span class="kw">floor</span>(<span class="kw">range</span>(boot_ests[TRMOBSCI <span class="op">&lt;=</span><span class="st"> </span>TRMOBSCIUPP <span class="op">&amp;</span><span class="st"> </span>TRMOBSCI <span class="op">&gt;=</span><span class="st"> </span>TRMOBSCILOW, TRMOBSCI]))),</span>
<span id="cb9-21"><a href="#cb9-21"></a>           <span class="kw">max</span>(<span class="kw">ceiling</span>(<span class="kw">range</span>(boot_ests[TRMOBSCI <span class="op">&lt;=</span><span class="st"> </span>TRMOBSCIUPP <span class="op">&amp;</span><span class="st"> </span>TRMOBSCI <span class="op">&gt;=</span><span class="st"> </span>TRMOBSCILOW, TRMOBSCI]))))</span>
<span id="cb9-22"><a href="#cb9-22"></a></span>
<span id="cb9-23"><a href="#cb9-23"></a>plot_col &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> boot_ests[TRMOBSCI <span class="op">&lt;=</span><span class="st"> </span>TRMOBSCIUPP <span class="op">&amp;</span><span class="st"> </span>TRMOBSCI <span class="op">&gt;=</span><span class="st"> </span>TRMOBSCILOW, ], <span class="kw">aes</span>(<span class="dt">x =</span> M_YEAR, <span class="dt">y =</span> TRMOBSCI)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">colour =</span> <span class="st">&quot;orange&quot;</span>, <span class="dt">alpha =</span> <span class="fl">0.2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylim</span>(ylim_) <span class="op">+</span></span>
<span id="cb9-24"><a href="#cb9-24"></a><span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">data =</span> boot_ests[TRMOBSCI <span class="op">&lt;=</span><span class="st"> </span>TRMOBSCIUPP <span class="op">&amp;</span><span class="st"> </span>TRMOBSCI <span class="op">&gt;=</span><span class="st"> </span>TRMOBSCILOW, <span class="kw">median</span>(TRMOBSCI, <span class="dt">na.rm=</span><span class="ot">TRUE</span>), <span class="dt">by =</span> M_YEAR], <span class="kw">aes</span>(<span class="dt">x =</span> M_YEAR, <span class="dt">y =</span> V1), <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">colour =</span> <span class="st">&quot;dodgerblue4&quot;</span>) <span class="op">+</span></span>
<span id="cb9-25"><a href="#cb9-25"></a><span class="st">    </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">2</span>, <span class="dt">linetype =</span> <span class="st">&quot;dashed&quot;</span>, <span class="dt">color =</span> <span class="st">&quot;grey50&quot;</span>) <span class="op">+</span></span>
<span id="cb9-26"><a href="#cb9-26"></a><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="dt">minor_breaks =</span> <span class="kw">waiver</span>(), <span class="dt">limits =</span> <span class="kw">c</span>(<span class="dv">2005</span>, <span class="dv">2020</span>), <span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">2005</span>, <span class="dv">2020</span>, <span class="dt">by =</span> <span class="dv">5</span>)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb9-27"><a href="#cb9-27"></a><span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Year&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">ylab</span>(<span class="st">&quot;Abundance Incices (Log/Log(10))&quot;</span>) <span class="op">+</span></span>
<span id="cb9-28"><a href="#cb9-28"></a><span class="st">    </span><span class="kw">labs</span>(<span class="dt">subtitle =</span> <span class="kw">paste</span>(s_sp, bms_id, <span class="dt">sep =</span> <span class="st">&quot; &quot;</span>))</span>
<span id="cb9-29"><a href="#cb9-29"></a></span>
<span id="cb9-30"><a href="#cb9-30"></a>plot_col</span></code></pre></div>
<p><img src="site_indices_files/figure-html/collated_index_figure-1.png" width="672" /></p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
